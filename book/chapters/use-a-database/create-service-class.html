
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>创建服务类 · 简明 ASP.NET Core 手册</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Nate Barbettini">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-forkmegithub/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../add-more-features/" />
    
    
    <link rel="prev" href="create-migration.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../your-first-application/">
            
                <a href="../your-first-application/">
            
                    
                    你的第一个程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../your-first-application/get-the-sdk.html">
            
                <a href="../your-first-application/get-the-sdk.html">
            
                    
                    获取 SDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../your-first-application/hello-world-in-csharp.html">
            
                <a href="../your-first-application/hello-world-in-csharp.html">
            
                    
                    C# 版的 Hello World
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../your-first-application/create-aspnetcore-project.html">
            
                <a href="../your-first-application/create-aspnetcore-project.html">
            
                    
                    创建一个 ASP.NET Core 项目
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../mvc-basics/">
            
                <a href="../mvc-basics/">
            
                    
                    MVC 基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../mvc-basics/create-controller.html">
            
                <a href="../mvc-basics/create-controller.html">
            
                    
                    创建控制器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../mvc-basics/create-models.html">
            
                <a href="../mvc-basics/create-models.html">
            
                    
                    创建模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../mvc-basics/create-view.html">
            
                <a href="../mvc-basics/create-view.html">
            
                    
                    创建视图
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../mvc-basics/add-service-class.html">
            
                <a href="../mvc-basics/add-service-class.html">
            
                    
                    添加一个服务类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../mvc-basics/use-dependency-injection.html">
            
                <a href="../mvc-basics/use-dependency-injection.html">
            
                    
                    运用依赖注入
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../mvc-basics/finish-controller.html">
            
                <a href="../mvc-basics/finish-controller.html">
            
                    
                    完成控制器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../mvc-basics/update-the-layout.html">
            
                <a href="../mvc-basics/update-the-layout.html">
            
                    
                    修改布局
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../add-external-packages/">
            
                <a href="../add-external-packages/">
            
                    
                    添加外来软件包
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    运用数据库
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="connect-to-a-database.html">
            
                <a href="connect-to-a-database.html">
            
                    
                    连接数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="update-context.html">
            
                <a href="update-context.html">
            
                    
                    修改数据库上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="create-migration.html">
            
                <a href="create-migration.html">
            
                    
                    创建变更
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.4" data-path="create-service-class.html">
            
                <a href="create-service-class.html">
            
                    
                    创建服务类
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../add-more-features/">
            
                <a href="../add-more-features/">
            
                    
                    添加新特性
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../add-more-features/add-todo-items.html">
            
                <a href="../add-more-features/add-todo-items.html">
            
                    
                    添加 待办事项 条目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../add-more-features/complete-with-checkbox.html">
            
                <a href="../add-more-features/complete-with-checkbox.html">
            
                    
                    使用复选框标记条目完成
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../security-and-identity/">
            
                <a href="../security-and-identity/">
            
                    
                    安全和身份
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../security-and-identity/require-authentication.html">
            
                <a href="../security-and-identity/require-authentication.html">
            
                    
                    提示认证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../security-and-identity/using-identity-in-the-application.html">
            
                <a href="../security-and-identity/using-identity-in-the-application.html">
            
                    
                    在程序中使用身份
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../security-and-identity/authorization-with-roles.html">
            
                <a href="../security-and-identity/authorization-with-roles.html">
            
                    
                    按角色进行授权
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../security-and-identity/more-resources.html">
            
                <a href="../security-and-identity/more-resources.html">
            
                    
                    附加资源
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../automated-testing/">
            
                <a href="../automated-testing/">
            
                    
                    自动化测试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../automated-testing/unit-testing.html">
            
                <a href="../automated-testing/unit-testing.html">
            
                    
                    单元测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../automated-testing/integration-testing.html">
            
                <a href="../automated-testing/integration-testing.html">
            
                    
                    集成测试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../deploy-the-application/">
            
                <a href="../deploy-the-application/">
            
                    
                    部署程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../deploy-the-application/deploy-to-azure.html">
            
                <a href="../deploy-the-application/deploy-to-azure.html">
            
                    
                    部署到 Azure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../deploy-the-application/deploy-with-docker.html">
            
                <a href="../deploy-the-application/deploy-with-docker.html">
            
                    
                    使用 Docker 进行部署
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../conclusion/">
            
                <a href="../conclusion/">
            
                    
                    结束语
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >创建服务类</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x7C7B;"><a name="&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x7C7B;" class="plugin-anchor" href="#&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x7C7B;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x7C7B;</h2>
<p>&#x56DE;&#x987E; <em>MVC&#x57FA;&#x7840;</em> &#x7AE0;&#x8282;, &#x4F60;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; <code>FakeTodoItemService</code>&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x786C;&#x7F16;&#x7801;&#x7684; &#x5F85;&#x529E;&#x4E8B;&#x9879;&#x3002;&#x73B0;&#x5728;&#x4F60;&#x6709;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x670D;&#x52A1;&#x7C7B;&#xFF0C;&#x4ECE;&#x800C;&#x501F;&#x52A9; Entity Framework Core &#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x83B7;&#x53D6;&#x771F;&#x5B9E;&#x5185;&#x5BB9;&#x3002;</p>
<p>&#x5220;&#x9664;&#x6587;&#x4EF6; <code>FakeTodoItemService.cs</code>&#xFF0C;&#x5E76;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x6587;&#x4EF6;:</p>
<p><strong>Services/TodoItemService.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Data;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.Services</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemService</span> : <span class="hljs-title">ITodoItemService</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ApplicationDbContext _context;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TodoItemService</span>(<span class="hljs-params">ApplicationDbContext context</span>)
        </span>{
            _context = context;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TodoItem[]&gt; GetIncompleteItemsAsync()
        {
            <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> _context.Items
                .Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
                .ToArrayAsync();
            <span class="hljs-keyword">return</span> items;
        }
    }
}
</code></pre>
<p>&#x4F60;&#x5E94;&#x8BE5;&#x6CE8;&#x610F;&#x5230;&#x76F8;&#x540C;&#x7684;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x6A21;&#x5F0F;&#xFF0C;&#x5982;&#x4F60;&#x5728; <em>MVC&#x57FA;&#x7840;</em> &#x7AE0;&#x8282;&#x6240;&#x89C1;&#x5230;&#x7684;&#x90A3;&#x6837;&#xFF0C;&#x53EA;&#x662F;&#x8FD9;&#x6B21;&#x88AB;&#x6CE8;&#x5165;&#x7684;&#x670D;&#x52A1;&#x662F; <code>ApplicationDbContext</code>&#x3002;<code>ApplicationDbContext</code> &#x5DF2;&#x7ECF;&#x5728;<code>ConfigureServices</code> &#x65B9;&#x6CD5;&#x91CC;&#x88AB;&#x6DFB;&#x52A0;&#x5230;&#x670D;&#x52A1;&#x5BB9;&#x5668;&#x91CC;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x4ED4;&#x7EC6;&#x63A2;&#x7A76; <code>GetIncompleteItemsAsync</code> &#x65B9;&#x6CD5;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x9996;&#x5148;&#xFF0C;&#x5B83;&#x7528;&#x6570;&#x636E;&#x5E93;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x7684; <code>Items</code> &#x7684;&#x5C5E;&#x6027;&#x83B7;&#x53D6; <code>DbSet</code> &#x4E2D;&#x6240;&#x6709;&#x7684; &#x5F85;&#x529E;&#x4E8B;&#x9879;:</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> _context.Items
</code></pre>
<p>&#x7136;&#x540E;&#xFF0C;<code>Where</code> &#x7528;&#x4E8E;&#x8FC7;&#x6EE4;&#x51FA;&#x6240;&#x6709;&#x201C;&#x672A;&#x5B8C;&#x6210;&#x201D;&#x7684;&#x6761;&#x76EE;:</p>
<pre><code class="lang-csharp">.Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
</code></pre>
<p><code>Where</code> &#x65B9;&#x6CD5;&#x6765;&#x81EA; C# &#x91CC;&#x7684;&#x4E00;&#x4E2A;&#x540D;&#x4E3A; <code>LINQ</code>(<strong>l</strong>anguage <strong>in</strong>tegrated <strong>q</strong>uery) &#x7684;&#x7279;&#x6027;&#xFF0C;&#x5B83;&#x53D7;&#x5230;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x7684;&#x542F;&#x53D1;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x5728;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x91CC;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x7684;&#x5199;&#x6CD5;&#x3002;&#x5728;&#x5E95;&#x5C42;&#xFF0C;Entity Framework Core &#x628A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7FFB;&#x8BD1;&#x6210;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x7684;&#x8BED;&#x53E5; <code>SELECT * FROM Items WHERE IsDone = 0</code>&#xFF0C;&#x6216;&#x5728; NoSQL&#x6570;&#x636E;&#x5E93; &#x91CC;&#x7684;&#x4E00;&#x4E2A;&#x7B49;&#x6548;&#x67E5;&#x8BE2;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;<code>ToArrayAsync</code> &#x65B9;&#x6CD5;&#x5429;&#x5490; Entity Framework Core &#x53D6;&#x51FA;&#x6240;&#x6709;&#x8FC7;&#x6EE4;&#x540E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5E76;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x8FD4;&#x56DE;&#x3002;<code>ToArrayAsync</code> &#x662F;&#x5F02;&#x6B65;&#x7684;(&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; <code>Task</code>)&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x6267;&#x884C;&#x4E00;&#x6B21; <code>await</code>&#xFF08;&#x7B49;&#x5F85;&#xFF09; &#x4EE5;&#x83B7;&#x53D6;&#x5176;&#x4E2D;&#x7684;&#x503C;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60F3;&#x4F7F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x53D8;&#x7B80;&#x77ED;&#x4E00;&#x70B9;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#x4E2D;&#x95F4;&#x53D8;&#x91CF; <code>items</code>&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#xFF08;&#x8DDF;&#x539F;&#x6765;&#x529F;&#x80FD;&#x4E00;&#x6837;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TodoItem[]&gt; GetIncompleteItemsAsync()
{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _context.Items
        .Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
        .ToArrayAsync();
}
</code></pre>
<h3 id="&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x5BB9;&#x5668;"><a name="&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x5BB9;&#x5668;" class="plugin-anchor" href="#&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x5BB9;&#x5668;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x5BB9;&#x5668;</h3>
<p>&#x7531;&#x4E8E;&#x4F60;&#x5220;&#x9664;&#x4E86; <code>FakeTodoItemService</code> &#x7C7B;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x4FEE;&#x6539; <code>ConfigureServices</code> &#x65B9;&#x6CD5;&#x91CC;&#x914D;&#x7F6E;<code>ITodoItemService</code> &#x63A5;&#x53E3;&#x7684;&#x90A3;&#x4E00;&#x884C;:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;ITodoItemService, TodoItemService&gt;();
</code></pre>
<p><code>AddScoped</code> &#x4F1A;&#x4EE5; <strong>scoped</strong> &#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x628A;&#x4F60;&#x7684;&#x670D;&#x52A1;&#x6DFB;&#x52A0;&#x5230;&#x5BB9;&#x5668;&#x91CC;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x6BCF;&#x6B21; web &#x8BF7;&#x6C42;&#x4E2D;&#xFF0C;&#x4E00;&#x4E2A; <code>TodoItemService</code> &#x7C7B;&#x7684;&#x65B0;&#x5B9E;&#x4F8B;&#x5C31;&#x4F1A;&#x88AB;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x3002;&#x8FD9;&#x5BF9;&#x4E8E;&#x90A3;&#x4E9B;&#x8DDF;&#x6570;&#x636E;&#x5E93;&#x6253;&#x4EA4;&#x9053;&#x7684;&#x7C7B;&#x6765;&#x8BF4;&#xFF0C;&#x662F;&#x5FC5;&#x8981;&#x7684;&#x3002;</p>
<blockquote>
<p>&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x7C7B;&#x53BB;&#x8DDF; Entity Framework Core&#xFF08;&#x4EE5;&#x53CA;&#x4F60;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF09;&#x6253;&#x4EA4;&#x9053;&#xFF0C;&#x5982;&#x679C;&#x7528;&#x5355;&#x4EF6;&#xFF08;&#x6216;&#x5176;&#x5B83;&#xFF09;&#x751F;&#x547D;&#x5468;&#x671F;&#x4F1A;&#x5F15;&#x53D1;&#x9EBB;&#x70E6;&#xFF0C;&#x539F;&#x56E0;&#x5728;&#x4E8E; Entity Framework Core &#x5E95;&#x5C42;&#x4EE5;&#x8BF7;&#x6C42;&#x4E3A;&#x5355;&#x4F4D;&#x7BA1;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x3002;&#x8981;&#x907F;&#x514D;&#x8FD9;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x8BF7;&#x5728;&#x8DDF; Entity Framework Core &#x6253;&#x4EA4;&#x9053;&#x7684;&#x670D;&#x52A1;&#x4E0A;&#xFF0C;&#x59CB;&#x7EC8;&#x91C7;&#x7528; scoped &#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
</blockquote>
<p>&#x4F9D;&#x8D56;&#x4E8E;&#x88AB;&#x6CE8;&#x5165;&#x7684; <code>ITodoItemService</code> &#x7684; <code>TodoController</code> &#x5C06;&#x5E78;&#x798F;&#x5730;&#x5BF9;&#x8FD9;&#x4E2A;&#x53D8;&#x5316;&#x6BEB;&#x65E0;&#x5BDF;&#x89C9;&#xFF0C;&#x4F46;&#x5728;&#x5E95;&#x5C42;&#xFF0C;&#x4F60;&#x5C06;&#x4F7F;&#x7528; Entity Framework Core &#x4E0E;&#x771F;&#x5B9E;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF01;</p>
<h3 id="&#x8BD5;&#x8BD5;&#x770B;"><a name="&#x8BD5;&#x8BD5;&#x770B;" class="plugin-anchor" href="#&#x8BD5;&#x8BD5;&#x770B;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8BD5;&#x8BD5;&#x770B;</h3>
<p>&#x542F;&#x52A8;&#x7A0B;&#x5E8F;&#x5E76;&#x5BFC;&#x822A;&#x81F3; <code>http://localhost:5000/todo</code>&#x3002;&#x786C;&#x7F16;&#x7801;&#x7684;&#x90A3;&#x4E9B;&#x6761;&#x76EE;&#x4E0D;&#x89C1;&#x4E86;&#xFF0C;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x53D1;&#x8D77;&#x4E86;&#x771F;&#x6B63;&#x7684;&#x67E5;&#x8BE2;&#x3002;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x521A;&#x597D;&#x8FD8;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5DF2;&#x5B58;&#x7684; &#x5F85;&#x529E;&#x4E8B;&#x9879;&#x6761;&#x76EE;&#xFF0C;&#x6240;&#x4EE5;&#x9875;&#x9762;&#x76EE;&#x524D;&#x8FD8;&#x662F;&#x7A7A;&#x767D;&#x7684;&#x3002;</p>
<p>&#x4E0B;&#x4E00;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x5728;&#x7A0B;&#x5E8F;&#x4E2D;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4ECE;&#x201C;&#x521B;&#x5EFA;&#x65B0; &#x5F85;&#x529E;&#x4E8B;&#x9879; &#x7684;&#x80FD;&#x529B;&#x201D;&#x5F00;&#x59CB;&#x3002;</p>
<hr>
<h2 id="create-a-new-service-class"><a name="create-a-new-service-class" class="plugin-anchor" href="#create-a-new-service-class"><i class="fa fa-link" aria-hidden="true"></i></a>Create a new service class</h2>
<p>Back in the <em>MVC basics</em> chapter, you created a <code>FakeTodoItemService</code> that contained hard-coded to-do items. Now that you have a database context, you can create a new service class that will use Entity Framework Core to get the real items from the database.</p>
<p>Delete the <code>FakeTodoItemService.cs</code> file, and create a new file:</p>
<p><strong>Services/TodoItemService.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Data;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.Services</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemService</span> : <span class="hljs-title">ITodoItemService</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ApplicationDbContext _context;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TodoItemService</span>(<span class="hljs-params">ApplicationDbContext context</span>)
        </span>{
            _context = context;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TodoItem[]&gt; GetIncompleteItemsAsync()
        {
            <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> _context.Items
                .Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
                .ToArrayAsync();
            <span class="hljs-keyword">return</span> items;
        }
    }
}
</code></pre>
<p>You&apos;ll notice the same dependency injection pattern here that you saw in the <em>MVC basics</em> chapter, except this time it&apos;s the <code>ApplicationDbContext</code> that&apos;s getting injected. The <code>ApplicationDbContext</code> is already being added to the service container in the <code>ConfigureServices</code> method, so it&apos;s available for injection here.</p>
<p>Let&apos;s take a closer look at the code of the <code>GetIncompleteItemsAsync</code> method. First, it uses the <code>Items</code> property of the context to access all the to-do items in the <code>DbSet</code>:</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> _context.Items
</code></pre>
<p>Then, the <code>Where</code> method is used to filter only the items that are not complete:</p>
<pre><code class="lang-csharp">.Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
</code></pre>
<p>The <code>Where</code> method is a feature of C# called LINQ (<strong>l</strong>anguage <strong>in</strong>tegrated <strong>q</strong>uery), which takes inspiration from functional programming and makes it easy to express database queries in code. Under the hood, Entity Framework Core translates the <code>Where</code> method into a statement like <code>SELECT * FROM Items WHERE IsDone = 0</code>, or an equivalent query document in a NoSQL database.</p>
<p>Finally, the <code>ToArrayAsync</code> method tells Entity Framework Core to get all the entities that matched the filter and return them as an array. The <code>ToArrayAsync</code> method is asynchronous (it returns a <code>Task</code>), so it must be <code>await</code>ed to get its value.</p>
<p>To make the method a little shorter, you can remove the intermediate <code>items</code> variable and just return the result of the query directly (which does the same thing):</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TodoItem[]&gt; GetIncompleteItemsAsync()
{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _context.Items
        .Where(x =&gt; x.IsDone == <span class="hljs-keyword">false</span>)
        .ToArrayAsync();
}
</code></pre>
<h3 id="update-the-service-container"><a name="update-the-service-container" class="plugin-anchor" href="#update-the-service-container"><i class="fa fa-link" aria-hidden="true"></i></a>Update the service container</h3>
<p>Because you deleted the <code>FakeTodoItemService</code> class, you&apos;ll need to update the line in <code>ConfigureServices</code> that is wiring up the <code>ITodoItemService</code> interface:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;ITodoItemService, TodoItemService&gt;();
</code></pre>
<p><code>AddScoped</code> adds your service to the service container using the <strong>scoped</strong> lifecycle. This means that a new instance of the <code>TodoItemService</code> class will be created during each web request. This is required for service classes that interact with a database.</p>
<blockquote>
<p>Adding a service class that interacts with Entity Framework Core (and your database) with the singleton lifecycle (or other lifecycles) can cause problems, because of how Entity Framework Core manages database connections per request under the hood. To avoid that, always use the scoped lifecycle for services that interact with Entity Framework Core.</p>
</blockquote>
<p>The <code>TodoController</code> that depends on an injected <code>ITodoItemService</code> will be blissfully unaware of the change in services classes, but under the hood it&apos;ll be using Entity Framework Core and talking to a real database!</p>
<h3 id="test-it-out"><a name="test-it-out" class="plugin-anchor" href="#test-it-out"><i class="fa fa-link" aria-hidden="true"></i></a>Test it out</h3>
<p>Start up the application and navigate to <code>http://localhost:5000/todo</code>. The fake items are gone, and your application is making real queries to the database. There doesn&apos;t happen to be any saved to-do items, so it&apos;s blank for now.</p>
<p>In the next chapter, you&apos;ll add more features to the application, starting with the ability to create new to-do items.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="create-migration.html" class="navigation navigation-prev " aria-label="Previous page: 创建变更">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../add-more-features/" class="navigation navigation-next " aria-label="Next page: 添加新特性">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"创建服务类","level":"1.5.4","depth":2,"next":{"title":"添加新特性","level":"1.6","depth":1,"path":"chapters/add-more-features/README.md","ref":"chapters/add-more-features/README.md","articles":[{"title":"添加 待办事项 条目","level":"1.6.1","depth":2,"path":"chapters/add-more-features/add-todo-items.md","ref":"chapters/add-more-features/add-todo-items.md","articles":[]},{"title":"使用复选框标记条目完成","level":"1.6.2","depth":2,"path":"chapters/add-more-features/complete-with-checkbox.md","ref":"chapters/add-more-features/complete-with-checkbox.md","articles":[]}]},"previous":{"title":"创建变更","level":"1.5.3","depth":2,"path":"chapters/use-a-database/create-migration.md","ref":"chapters/use-a-database/create-migration.md","articles":[]},"dir":"ltr"},"config":{"plugins":["expandable-chapters-small","disqus","splitter","anchors","copy-code-button","forkmegithub"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"little-aspnetcore-book-cn"},"splitter":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"expandable-chapters-small":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"forkmegithub":{"color":"orange","url":"https://github.com/windsting/little-aspnetcore-book"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","author":"Nate Barbettini","pdf":{"pageNumbers":true,"fontSize":13,"fontFamily":"Microsoft YaHei","paperSize":"a5","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"简明 ASP.NET Core 手册","language":"zh-hans","gitbook":"*","description":"一个关于“使用 ASP.NET Core 框架的构建 web 应用程序”的入门简介。"},"file":{"path":"chapters/use-a-database/create-service-class.md","mtime":"2020-12-02T18:04:53.178Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-02T18:52:41.522Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-forkmegithub/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

